---

title: learn


keywords: fastai
sidebar: home_sidebar

summary: "Classes and functions for training and predicting."
description: "Classes and functions for training and predicting."
nb_path: "06_learn.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 06_learn.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helpers">Helpers<a class="anchor-link" href="#Helpers"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_to_checkpoint" class="doc_header"><code>save_to_checkpoint</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L13" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_to_checkpoint</code>(<strong><code>epoch_index</code></strong>, <strong><code>model</code></strong>, <strong><code>optimizer</code></strong>, <strong><code>path</code></strong>)</p>
</blockquote>
<p>Save model and optimizer state_dicts to checkpoint</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_from_checkpoint" class="doc_header"><code>load_from_checkpoint</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_from_checkpoint</code>(<strong><code>model</code></strong>, <strong><code>path</code></strong>, <strong><code>optimizer</code></strong>=<em><code>None</code></em>, <strong><code>for_inference</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Load from checkpoint - model, optimizer &amp; epoch_index for training or just model for inference</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_loss_fn" class="doc_header"><code>get_loss_fn</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_loss_fn</code>(<strong><code>pos_wts</code></strong>)</p>
</blockquote>
<p>Return <code>nn.BCEWithLogitsLoss</code> with the given positive weights</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RunHistory" class="doc_header"><code>class</code> <code>RunHistory</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L45" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RunHistory</code>(<strong><code>labels</code></strong>)</p>
</blockquote>
<p>Class to hold training and prediction run histories</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RunHistory</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Class to hold training and prediction run histories&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yhat_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yhat_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yhat_test</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Note</strong></p>
<ul>
<li><code>y</code> and <code>y_hat</code> are actual (ground truth and predicted) values from <ul>
<li>the last epoch of <code>fit()</code> for <a href="/lemonade/learn.html#train"><code>train</code></a> and <code>valid</code>, </li>
<li>the last run of <code>predict()</code> for <code>test</code> </li>
</ul>
</li>
<li><a href="/lemonade/learn.html#train"><code>train</code></a>, <code>valid</code> and <code>test</code> are calculated loss and accuracy values at the end of each epoch<ul>
<li>for <code>test</code> there is only a single epoch in each run</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="fit-&amp;-predict">fit &amp; predict<a class="anchor-link" href="#fit-&amp;-predict"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="BCEWithLogitsLoss-&amp;-torch.sigmoid"><code>BCEWithLogitsLoss</code> &amp; <code>torch.sigmoid</code><a class="anchor-link" href="#BCEWithLogitsLoss-&amp;-torch.sigmoid"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Using <code>BCEWithLogitsLoss</code> because its <a href="https://pytorch.org/docs/stable/generated/torch.nn.BCEWithLogitsLoss.html">more numerically stable than using a plain Sigmoid followed by a BCELoss</a></li>
<li>Also accomodates multi-label classification &amp; class-imbalanced datasets due to the use of <code>pos_weights</code></li>
<li>But this means that the model does not do a final sigmoid at the output layer, since thats done by the loss function</li>
<li>So need to do a <code>torch.sigmoid</code> on the <code>yhat</code>s before using them to calculate accuracy</li>
<li>2 good discussions on this topic<ul>
<li><a href="https://discuss.pytorch.org/t/how-to-interpret-the-probability-of-classes-in-binary-classification/45709">How to interpret the probability of classes in binary classification?</a></li>
<li><a href="https://discuss.pytorch.org/t/bcewithlogitsloss-and-model-accuracy-calculation/59293/2">BCEWithLogitsLoss and model accuracy calculation</a></li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train" class="doc_header"><code>train</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L53" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train</code>(<strong><code>model</code></strong>, <strong><code>train_dl</code></strong>, <strong><code>train_loss_fn</code></strong>, <strong><code>optimizer</code></strong>, <strong><code>lazy</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Train model using train dataset</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="evaluate" class="doc_header"><code>evaluate</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L75" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>evaluate</code>(<strong><code>model</code></strong>, <strong><code>eval_dl</code></strong>, <strong><code>eval_loss_fn</code></strong>, <strong><code>lazy</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Evaluate model - used for validation (while training) and prediction</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fit" class="doc_header"><code>fit</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L93" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fit</code>(<strong><code>epochs</code></strong>, <strong><code>history</code></strong>, <strong><code>model</code></strong>, <strong><code>train_loss_fn</code></strong>, <strong><code>valid_loss_fn</code></strong>, <strong><code>optimizer</code></strong>, <strong><code>accuracy_fn</code></strong>, <strong><code>train_dl</code></strong>, <strong><code>valid_dl</code></strong>, <strong><code>lazy</code></strong>=<em><code>True</code></em>, <strong><code>to_chkpt_path</code></strong>=<em><code>None</code></em>, <strong><code>from_chkpt_path</code></strong>=<em><code>None</code></em>, <strong><code>verbosity</code></strong>=<em><code>0.75</code></em>)</p>
</blockquote>
<p>Fit model and return results in <code>history</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="predict" class="doc_header"><code>predict</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L137" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>predict</code>(<strong><code>history</code></strong>, <strong><code>model</code></strong>, <strong><code>test_loss_fn</code></strong>, <strong><code>accuracy_fn</code></strong>, <strong><code>test_dl</code></strong>, <strong><code>chkpt_path</code></strong>, <strong><code>lazy</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Predict and return results in <code>history</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Plotting">Plotting<a class="anchor-link" href="#Plotting"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_loss" class="doc_header"><code>plot_loss</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L154" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_loss</code>(<strong><code>history_df</code></strong>, <strong><code>title</code></strong>=<em><code>'Loss'</code></em>, <strong><code>axis</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Plot loss</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_losses" class="doc_header"><code>plot_losses</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L168" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_losses</code>(<strong><code>train_history</code></strong>, <strong><code>valid_history</code></strong>)</p>
</blockquote>
<p>Plot multiple losses (train and valid) side by side</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_aurocs" class="doc_header"><code>plot_aurocs</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L177" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_aurocs</code>(<strong><code>history_df</code></strong>, <strong><code>title</code></strong>=<em><code>'AUROC Scores'</code></em>, <strong><code>axis</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Plot AUROC scores</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_train_valid_aurocs" class="doc_header"><code>plot_train_valid_aurocs</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L190" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_train_valid_aurocs</code>(<strong><code>train_history</code></strong>, <strong><code>valid_history</code></strong>)</p>
</blockquote>
<p>Plot train and valid AUROC scores side by side</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summarize">Summarize<a class="anchor-link" href="#Summarize"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_fit_results" class="doc_header"><code>plot_fit_results</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L198" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_fit_results</code>(<strong><code>history</code></strong>, <strong><code>labels</code></strong>)</p>
</blockquote>
<p>All plots after fit - ROC curves, losses and AUROCs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="summarize_prediction" class="doc_header"><code>summarize_prediction</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L207" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>summarize_prediction</code>(<strong><code>history</code></strong>, <strong><code>labels</code></strong>, <strong><code>plot</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Summarize after prediction - plot ROC curves, calculate auroc, optimal threshold and 95% CI for AUROC and return results in <code>history</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="count_parameters" class="doc_header"><code>count_parameters</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/learn.py#L223" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>count_parameters</code>(<strong><code>model</code></strong>, <strong><code>printout</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Returns number of parameters in model</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

